<configuration>
    <target name="fd">

        <target.default>
            <media.storage>new-engine/config/storage.xml</media.storage>
        </target.default>

        <!-- produit des fichiers d'include pour lwasm en fonction d'un point de départ dans une page et d'une taille de page maximum. -->
        <!-- le xml en entrée contient une liste de plugins prévus pour être des enfants de lwasm (format="obj") -->
        <!-- on execute chaque plugin du xml puis on joue lwasm format"obj" sur chaque fichier résultant -->
        <!-- l'algorithme knapsack est ensuite joué pour former des groupes de fichier -->
        <!-- l'attribut assetnbfiles leve une erreur si le nb de fichiers produit est différent de l'attendu -->
        <knapsack offset="0x3000" maxsize="0x4000" assertnbfiles="4" in="src/assets/object/list.xml" out="src/assets/object/list.#.xml">
            <lwasm format="obj">
                <lwasm.define symbol="debug" value="1"/>
            </lwasm>
        </knapsack>

        <media storage="fd640 boot" fat="thomson dd">
            <media.out type="fd" file="demo.fd" />
            <media.default>
                <file.maxsize>0x4000</file.maxsize>
            </media.default>

            <section name="SCENE" face="0" track="0"  sector="9"/>
            <section name="INDEX" face="1" track="0"  sector="1"/>
            <section name="DATA"  face="0" track="1"  sector="1"/>

            <file section="BOOT" maxsize="0x100">   
                <checksum type="moto.fd640.boot">
                    <lwasm format="raw">
                        <lwasm.define symbol="debug" value="1"/>
                        <asm>new-engine/system/to8/bootloader/boot.asm</asm>
                    </lwasm>
                </checksum>
            </file>

            <file section="LOAD">
                <lwasm format="raw">
                    <asm>new-engine/system/to8/bootloader/loader.asm</asm> <!-- a single file -->
                </lwasm>
            </file>

            <directory id="0" section="INDEX"> <!-- retourne à media une liste de binaires à écrire dans des sections : List<objet> contenant deux champs : Section, byte[] (qu'il s'agisse du répertoire ou de fichiers, ce sont les mêmes données -->
                                               <!-- agrège les direntry pour construire le répertoire, remonte ce répertoire+section et les données de fichiers+section -->

                <direntry name="assets.main.title" codec="zx0" loadtimelink="LINK"> <!-- retourne une liste à deux éléments avec deux types d'objects possibles : DirEntryData (byte[] bin) ou SectionData (Section section, byte[] bin) -->
                                                                                    <!-- Directory devra tester le classname avant toute action sur un élément de la liste -->
                                                                                    <!-- DirEntryData et SectionData implémentent la même interface PluginData -->
                                                                                    <!-- compresse les données bin avec le codec (optionel, default none) -->
                                                                                    <!-- effectue la création d'un index loadtimelink avec les données des objets LWObject (optionel, default none) -->
                                                                                    <!-- sauvegarde les données de link sur le media (linksection)-->
                                                                                    <!-- pour sauvegarder les données index loadtimelink, on a besoin des objets distincts -->
                    <file section="DATA">  <!-- retourne une liste à n éléments de LWData (interface PluginData) contenant deux champs : Section section, LWInterface obj (obj est soit de type LWRaw soit LWObject) -->
                                           <!-- controle un fichier (file) fait au max une page de RAM, maxsize est un champ obligatoire de file -->
                                            <!-- dans file ci dessous on retrouve le contenu des données dans une page de RAM (partielle ou entiere) -->
                        <lwasm format="obj"> <!-- concat de tous les fichiers .asm et build unique -->
<!-- TODO params -->        <gfxcomp symbol="img.test">src/assets/object/image/test.png</gfxcomp>     <!-- tout plugin dans lwasm est attendu comme renvoyant une liste de noms de fichier (lwasm va les concat avant d'assembler) -->
                                                                                                      <!-- produce a file in the build dir, with the generated asm code-->
                                                                                                      <!-- return the name of the file -->
                                                                                                      <!-- les index d'image et d'animation seront insérés par le developpeur dans le code par macro (generera la structure) et par etiquettes (voir param du csprite) -->
                            <asm>src/assets/object/01.asm</asm> <!-- nom de fichier ou de répertoire (possibilité de "filter") -->
                        </lwasm>                                                                      
                    </file>
                </direntry>
                <direntry name="assets.main.stage1" codec="zx0" loadtimelink="LINK">
                    <file section="DATA">
                        <lwasm format="obj">
                            <lwasm.define symbol="debug" value="1"/>
                            <include>src/assets/object/list.0.xml</include> <!-- permet d'importer des sous définitions (gfxcomp, asm, ...) -->
                        </lwasm>
                    </file>
                </direntry>
                <direntry name="assets.music.stage1">
                    <file section="DATA">
                        <bin>src/assets/music/stage1.bin</bin>
                    </file>
                </direntry>
            </directory>

            <fat:directory name="IMAGEBAS" section="FAT0">
                <fat:direntry name="auto.bat">
                <fat:file block="130">
                    <txt2bas tokenset="to" filename="src/assets/basic/auto.bat"/> <!-- txt2bas plugin -->
                </fat:file>
                </fat:direntry>
                <fat:direntry name="image.map">
                    <fat:file block="131">
                        <bin>src/assets/image/rtype.map</bin> <!-- bin plugin -->
                    </fat:file>
                </fat:direntry>
            </fat:directory>

<!-- index tell that this is the custom directory type, 0 is the disk number / directory id -->
<!-- txt2bas tokenset : mo, to, nano, coco, dragon. (default is to)-->
<!-- FAT will use block as starting point, will throw an error if block are not contiguous (no more free space) -->

        </media>
    </target>
</configuration>

<!-- pour la T.2
        <section name="BOOT"  page="0" org="0"/>
        <section name="LOAD"  page="0" org="0x100"/>
        <section name="INDEX" page="0" org="0x200"/>
        <section name="DATA"  page="0" org="0x300"/>
-->
<!-- pour la FD
            <section name="BOOT"  face="0" track="0"  sector="1"/>
            <section name="LOAD"  face="0" track="0"  sector="2"/>
            <section name="SCENE" face="0" track="0"  sector="9"/>
            <section name="INDEX" face="1" track="0"  sector="1"/>
            <section name="FAT0"  face="0" track="20" sector="1"/>
            <section name="FAT1"  face="1" track="20" sector="1"/>
            <section name="DATA"  face="0" track="1"  sector="1"/>
-->