Build a game
=

## Description

Building a game is the process of assembling all source code of a game and encode the result in a storage media for a dedicated system.

## Systems

The game builder support the following 6809 systems :

system|clock|manufacturer|year
-|-|-|-
to8|1 MHz|Thomson|1986
to8d|1 MHz|Thomson|1987
to9+|1 MHz|Thomson|1986

## Storage media

The builder handle several media types, all are specific to a system or a system familly.

system|storage media|max. size|file extension
-|-|-|-
to8, to8d, to9+|floppy disk|640 KiB|.fd, .hfe
to8, to8d, to9+|[SDDRIVE] (sd card)|16 GiB|.sd
to8, to8d, to9+|[Megarom T.2] (rom)|2 GiB|.rom (loader in .sd)

## Usage

The builder needs an input file that provide :
- target system
- storage media
- boot (asm)
- loader (asm)
- package index (.asm)
- packages configuration files

**fd.xml**

    <system>to8</system>
    <storage-media>fd</storage-media>
    <name>my-game</name>
    <boot>boot-fd.asm</boot>
    <loader>loader-fd.asm</loader>

    <packages>
        <index>package-index.asm</index>
        <boot>3</boot>
        <package>character-1.xml</package>
    	<package>character-2.xml</package>
    	<package>character-3.xml</package>
    	<package>level-main.xml</package>
    </packages>

the boot.asm and loader-fd.asm are provided by the asm engine.  
the package-index.asm will be generated by a tool.  
the package files can be written manually or generated by a tool.  
the boot id refers to the package-id in package definition, it tells the builder wich package to load and execute after the boot sequence.

## Package definition
---

The purpose of a package is to be able to load a group of data and code in RAM by only using an id and a destination page. The package content will fill one or more RAM pages. The package can also be loaded in the resident memory, in this case the page number will be ignored by the loader.  

A package defines a set of package element.

**Use case**  
At runtime, the main programm is able to load several packages in RAM.
Here is a use case of package organization in ram during a game :

![package][package]

In this configuration, packages may be loaded in different page locations.
This is the case for the **character 2** package.  

**Dynamic linking**  
A package is assembled with absolute addressing, thus the loader will always load a package at the same ram address, but it may be loaded in a different ram page.  
To be able to resolve the page id of each ressource at runtime, a link task is executed after loading all the required packaging.

## File structure

**character-1.xml**

    <package-id>1</package-id>
    <package-elements>
    	<compression>none</compression>
    	<cluster-size>$2000</cluster-size>
    	<location>$0000-$3FFF</location>	
    	<org>$0000</org>
    	<package-element>
    		<file>01.asm</file>
                <org>$1000</org>
    	</package-element>			
    	<package-element>
    		<file>02.asm</file>
    		<compression>zx0</compression>
    	</package-element>			
    	<package-element>
    		<file>03.asm</file>
    		<compression>zx0</compression>
    	</package-element>			
    </package-elements>

In package-elements field, the values for :
 - compression
 - cluster-size
 - location
 - org

are the default values for package elements. Those values can be overided in each package-element.

The path of each file must be relative to the game project base directory.  

The builder will report a fatal error if the binary produced for the package exceed the size declared by the end location minus the org starting position.

### compression
---

value|version|description|direction
-|-|-|-
none|1|stack blast copy (preprocessed data)|backward
exo|2|exomizer|backward
zx0|1|zx0|forward

### cluster-size
---

The cluster size allows you to load a page in several steps.  

Use case with the TO8 Thomson :

There is a distortion between RAM locations in the TO8 memory management.  
Here is the correspondence between the two locations :  
cartridge|data
-|-
$0000-$1FFF|$C000-DFFF
$2000-$3FFF|$A000-BFFF

Builder strategy
- the package element is builded in a 16KiB space :  

        <location>$0000-$3FFF</location>

- the package element is clustered in 8KiB :

        <cluster-size>$2000</cluster-size>

- the builder will write an index with two 8KiB entries

Loader strategy
- the loader will handle address translation and invert the two 8KiB bank, based on destination provided by the index

### location
---

The location is the expected running location for the code.

The location is used to :
- set the destination location in the package index.  
- give the destination page size, used to split the package into pages.

The value should be expressed in hexadecimal with an hyphen between the min and max value.  
example : $0000-$3FFF

### org
---

The org sets the origin where the package begin, somewhere in a middle of a page. It is also used to assemble the code to the right location.
The value should be expressed in hexadecimal.

## Package element definition
---

A package element is a set of assembly files that will be assembled to make a binary. This binary will be loaded in a countiguous RAM space at runtime.

![package-element][package-element]

## File structure

The package element is an assembly file that includes other assembly files.  
This file can be created manually or generated by a tool.  
The tool will find the layout that uses the less page space.
			
01.asm
---------

    INCLUDE "obj01/obj01.asm"
    INCLUDE "obj01/image/img01.asm"	
    INCLUDE "obj01/image/img02.asm"
    INCLUDE "obj01/image/img03.asm"			
						
		
dans le code on a besoin de faire référence à la page d'un objet
on déclare dans les constantes :
PAGE_IDX equ 0
			
on déclare dans l'objet buzzer :
pge_ehz_buzzer equ PAGE_IDX
			
on utilise dans le code ailleurs :
lda   #pge_ehz_buzzer			
			
extraire des fichiers objets du package, les addresses d'utilisation des equates de tous les asm (liste plus haut)
construction d'un index pour chaque mention :
package id; page offset référence, adresse référence, page offset cible dans le package courant ou dans un autre
			
quand on référence une adresse de routine on a une adresse + offset de page dans le package
L'adresse est résolue par link

[SDDRIVE]: http://dcmoto.free.fr/bricolage/sddrive/index.html
[Megarom T.2]: https://megarom.forler.ch/fr/
[package]: package.png
[package-element]: package-element.png
