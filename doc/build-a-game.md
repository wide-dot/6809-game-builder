/[readme]/build-a-game

Build a game
=

## Description

Building a game is the process of assembling all source code of a game and encode the result in a storage media for a dedicated system.

## Systems

The game builder support the following 6809 systems :

system|clock|manufacturer|year
-|-|-|-
to8|1 MHz|Thomson|1986
to8d|1 MHz|Thomson|1987
to9+|1 MHz|Thomson|1986

## Storage media

The builder handle several media types, all are specific to a system or a system familly.

system|storage media|max. size|file extension
-|-|-|-
to8, to8d, to9+|floppy disk|640 KiB|.fd, .hfe
to8, to8d, to9+|[SDDRIVE] (sd card)|16 GiB|.sd
to8, to8d, to9+|[Megarom T.2] (rom)|2 MiB|.rom (loader in .sd)

## Usage

... TODO ...

## Config Example

### Floppy Disk

**fd.xml**

    <system>to8</system>
    
    <output-file name="hello-world" type="fd"/>
    <define symbol="debug" value="1"/>
    
    <boot package="pkg_gfx" page="pge_hello" address="adr_hello">engine/system/to8/boot/boot-fd.asm</boot>
    <loader>engine/system/to8/ram/ram-loader-fd.asm</loader>

    <packages>
        <package>src/package/hello-world.xml</package>
        <package>src/package/obj-01.xml</package>
        <package>src/package/obj-02.xml</package>
    </packages>

### SDDRIVE

**sd.xml**

    <system>to8</system>
    
    <output-file name="hello-world" type="sd"/>
    <define symbol="debug" value="1"/>
    
    <boot load-pkg="pkg_gfx" set-page="pge_hello" call-address="adr_hello">engine/system/to8/boot/boot-fd.asm</boot>
    <loader>engine/system/to8/ram/ram-loader-sd.asm</loader>
    
    <packages>
        <package>src/package/hello-world.xml</package>
        <package>src/package/obj-01.xml</package>
        <package>src/package/obj-02.xml</package>
    </packages>

### Megarom T.2

**rom.xml**

    <system>to8</system>
    
    <output-file name="hello-world" type="rom"/>
    <define symbol="debug" value="1"/>
    
    <boot set-page="pge_obj03" call-address="adr_obj03">engine/system/to8/boot/boot-t2.asm</boot>
    <loader>engine/system/to8/ram/ram-loader-t2.asm</loader>
    
    <packages>
        <package>src/package/hello-world.xml</package>
        <package>src/package/obj-01.xml</package>
        <package>src/package/obj-02.xml</package>
    </packages>

    <rom bank="$0000-$3FFF">
        <asm name="obj03">src/gfx/object/obj03/obj03.asm</asm>
        <bin name="gfx01">src/gfx/object/obj01/gfx01.bin</bin>
        <fileset>src/package/obj-03.xml</fileset>
        <fileset>src/package/obj-04.xml</fileset>
    </rom>

## How it works

Floppy disk and SDDRIVE (floppy disk emulation) images are produced by writing a boot loader, a ram loader, an index to read and load packages in ram and packages.

all parameters in the boot tag will be converted to pragma and symbols when assembling the boot loader. It will allow to set wich package to load and execute after the boot sequence.

Megarom T.2 images are produced the same way as for floppy disk, but add rom banks.

the boot parameters can be used to point to fileset resources if desired, it will start the program from the rom instead of ram.

### Package definition

The purpose of a package is to be able to load a group of data and code in RAM by only using an id.

There are three types of packages:
- [relocatable][package-relocatable]
- [absolute][package-absolute]
- [multi-page][package-multi-page]

### Runtime linking
A [multi-page package][package-multi-page] is assembled with absolute addressing, thus the loader will always load a package at the same ram address, but it may be loaded in different ram pages.  

To be able to resolve the page id of each ressource at runtime, a link task is executed after loading all the required packaging in ram. The linker will get the page offset of the ressource and add the page number used to load the package. All references to this variable will then be updated in memory.

The dynamic link will also update page id references to [relocatable][package-relocatable] and [absolute][package-absolute] packages.

In [relocatable][package-relocatable] package, the dynamic link is also able to update address references, it does not works for other types of packages.

### Rom definition

A rom defines a set of read only code and data.  
No ram loader index will be generated by the builder, the code or data are meant to be accessed directly on the rom.

The builder will :
- arrange the code and data of all rom files into a set of pages
- generate page symbols for all asm or bin files
- generate ram address symbols for all bin files
- run the assembly stage to produce object files

### Ram index
When using rom and ram at same time, Dynamic link will still be usable inside ram, but can not work in rom.  
Accessing ram from rom requires the use of a ram index stored in non-commutable memory. The ram index will be updated automatically by the Dynamic link, its up to the developper to set the ram index manually with the required values.

Example of ram index :

    ptr_pge_obj01 fcb pge_obj01

Usage

    lda ptr_pge_obj01 ; use from rom (ram index)
    lda #pge_obj01    ; use from ram (dynamic link)

### fileset

A fileset is a set of asm or bin file declaration.

    <fileset>
        <asm name="obj01">src/gfx/object/obj01/obj01.asm</asm>
        <asm name="obj02">src/gfx/object/obj02/obj02.asm</asm>
        <asm name="obj03">src/gfx/object/obj03/obj03.asm</asm>
        <bin name="gfx01">src/gfx/object/obj01/gfx01.bin</bin>
    </fileset>

[SDDRIVE]: http://dcmoto.free.fr/bricolage/sddrive/index.html
[Megarom T.2]: https://megarom.forler.ch/fr/
[package-relocatable]: package-relocatable.md
[package-absolute]: package-absolute.md
[package-multi-page]: package-multi-page.md

[readme]: ../readme.md
[build-a-game]: build-a-game.md